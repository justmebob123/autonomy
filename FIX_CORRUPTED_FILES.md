# Fixing Corrupted Files in /home/ai/AI/web

## Problem
The files in `/home/ai/AI/web` were corrupted by the old JSON encoding bug that used HTML entity `&quot;` instead of proper JSON escape `&quot;`. This caused "unexpected character after line continuation character" syntax errors.

## Root Cause
Before the fix, the autonomy system was encoding Python code like this:
```python
# Original code:
print("Hello World")

# Got encoded as:
print(&quot;Hello World&quot;)
```

This corruption happened during bidirectional JSON communication between the autonomy system and LLM APIs.

## Solution Options

### Option 1: Automated Fix Script (Recommended)
Create a script to automatically fix all corrupted files:

```python
#!/usr/bin/env python3
"""
Fix corrupted files that have &quot; instead of proper quotes.
"""

import os
import re
from pathlib import Path

def fix_file(filepath):
    """Fix a single file by replacing &quot; with proper quotes."""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # Check if file has corruption
        if '&quot;' not in content:
            return False
        
        # Fix the corruption
        fixed_content = content.replace('&quot;', '"')
        
        # Write back
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(fixed_content)
        
        print(f"✓ Fixed: {filepath}")
        return True
    except Exception as e:
        print(f"✗ Error fixing {filepath}: {e}")
        return False

def fix_directory(directory):
    """Fix all Python files in a directory."""
    directory = Path(directory)
    fixed_count = 0
    
    for filepath in directory.rglob('*.py'):
        if fix_file(filepath):
            fixed_count += 1
    
    return fixed_count

if __name__ == '__main__':
    import sys
    
    if len(sys.argv) < 2:
        print("Usage: python3 fix_corrupted_files.py <directory>")
        sys.exit(1)
    
    directory = sys.argv[1]
    print(f"Fixing corrupted files in: {directory}")
    
    fixed_count = fix_directory(directory)
    print(f"\n✓ Fixed {fixed_count} files")
```

**Usage:**
```bash
cd /home/ai/AI/autonomy
python3 fix_corrupted_files.py /home/ai/AI/web
```

### Option 2: Manual Fix with sed
For a quick fix of all files:

```bash
cd /home/ai/AI/web
find . -name "*.py" -type f -exec sed -i 's/&quot;/"/g' {} \;
```

### Option 3: Regenerate Files
If the files were generated by the autonomy system, you can:
1. Delete the corrupted files
2. Pull the latest autonomy system (with the JSON fix)
3. Re-run the autonomy system to regenerate the files

## Verification

After fixing, verify the files are correct:

```bash
cd /home/ai/AI/web
python3 -m py_compile chat/chat_handler.py
```

If no errors, the file is fixed!

## Prevention

The JSON encoding fix is now deployed in the autonomy system, so this corruption will not happen again for new files. The fix ensures:
- Proper JSON escaping using `json.dumps()`
- Standards-compliant encoding per RFC 8259
- No more HTML entities in JSON

## Files Affected

Based on the error log, these files are corrupted:
- chat/chat_handler.py
- comment/system.py
- editors/master_plan_editor.py
- managers/task_assignment_manager.py
- tools/gap_detection.py
- tools/risk_assessment_tool.py
- tools/web_search_tool.py
- middlewares/auth_middleware.py
- trackers/progress_tracker.py
- And many more...

Total: ~30+ files with "unexpected character after line continuation character" errors

## Next Steps

1. **Pull latest autonomy system:**
   ```bash
   cd /home/ai/AI/autonomy
   git pull origin main
   ```

2. **Fix corrupted files:**
   ```bash
   cd /home/ai/AI/web
   find . -name "*.py" -type f -exec sed -i 's/&quot;/"/g' {} \;
   ```

3. **Verify fixes:**
   ```bash
   cd /home/ai/AI/web
   python3 -m compileall .
   ```

4. **Re-run autonomy system:**
   ```bash
   cd /home/ai/AI/autonomy
   python3 run.py -vv ../web/
   ```

The system should now work without JSON encoding errors!